<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Class Directory - Conductor</title>
        <link rel="stylesheet" href="/src/styles/styles.css">
        <script type="module" async src="/src/js/common.js"></script>
    </head>
    <body>
        <main>
            <header>
                <h1>Class Directory</h1>
                <theme-toggle></theme-toggle>
            </header>
            <article id="directory-content">
                <p id="directory-loading">Loading directory...</p>
                <zing-grid
                    id="directory-grid"
                    style="display: block;"
                    caption="Class Directory"
                    theme="default"
                    pager
                    page-size="25"
                    page-size-options="10,25,50,100"
                    search>
                </zing-grid>
                <p id="directory-error" style="display: none; color: var(--color-error);"></p>
            </article>
        </main>
        <aside>
            <conductor-nav></conductor-nav>
        </aside>
        
        <script type="module">
            import { getCourseId, cacheUsersInCourse, getCachedUsers } from '/src/js/utils/cache-utils.js';
            import { getUserProfile } from '/src/js/api/profile.js';
            
            const directoryContent = document.getElementById('directory-content');
            const directoryLoading = document.getElementById('directory-loading');
            const directoryGrid = document.getElementById('directory-grid');
            const directoryError = document.getElementById('directory-error');
            
            async function getUserInfoByUserId(userId) {
                // Fetches user information from the database by user_id
                try {
                    const userInfo = await getUserProfile(userId);
                    return userInfo;
                } catch (error) {
                    console.error(`Error fetching user info for user_id ${userId}:`, error);
                    throw error;
                }
            }
            
            async function loadDirectory() {
                try {
                    // Get course ID from URL
                    const courseId = getCourseId();
                    if (!courseId) {
                        throw new Error('Course ID not found in URL');
                    }

                    // Fetch users in course (enrollments with user details)
                    let enrolledUsers;
                    const cached = getCachedUsers(courseId);
                    if (cached) {
                        enrolledUsers = cached;
                    } else {
                        enrolledUsers = await cacheUsersInCourse(courseId);
                    }
                    
                    if (!enrolledUsers || enrolledUsers.length === 0) {
                        directoryLoading.textContent = 'No participants found in this course.';
                        return;
                    }

                    console.log('enrolledUsers', enrolledUsers);

                    // Fetch user info for each enrollment and print it
                    const userInfoPromises = enrolledUsers.map(async (enrollment) => {
                        const userId = enrollment.user_id;
                        const userInfo = await getUserInfoByUserId(userId);
                        console.log(`User info for user_id ${userId}:`, userInfo);
                        return { enrollment, userInfo };
                    });

                    // Wait for all user info to be fetched
                    const enrollmentsWithUserInfo = await Promise.all(userInfoPromises);

                    // Transform enrollments to include user details in a flat structure for the grid
                    const gridData = enrollmentsWithUserInfo.map(({ enrollment, userInfo }) => {
                        return {
                            user_id: enrollment.user_id,
                            first_name: userInfo.first_name || 'N/A',
                            last_name: userInfo.last_name || 'N/A',
                            email: userInfo.email || 'N/A',
                            pronouns: userInfo.pronouns || 'N/A',
                            role: enrollment.role || 'N/A',
                            team_id: enrollment.team_id || 'N/A',
                            global_role: userInfo.global_role || 'N/A',
                        };
                    });

                    directoryGrid.data = gridData;
                    directoryLoading.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error loading directory:', error);
                    directoryLoading.style.display = 'none';
                    directoryError.textContent = `Error loading directory: ${error.message}`;
                    directoryError.style.display = 'block';
                }
            }
            
            loadDirectory();
        </script>
    </body>
</html>
