<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Class Directory - Conductor</title>
        <link rel="stylesheet" href="/src/styles/styles.css">
        <script type="module" async src="/src/js/common.js"></script>
        <script type="module" async src="/src/components/forms/add-user-form.js"></script>
    </head>
    <body>
        <main>
            <header>
                <h1>Class Directory</h1>
            </header>
            <article id="directory-content">

                <header>
                    <div class="grid-menu" role="menu">
                        <input
                            id="grid-search"
                            type="search"
                            placeholder="Search..."
                            aria-label="Search journals"
                        />
                        <div> <!-- Used to separate buttons from search -->
                            <button id='add-user-button'>Add User<i>add</i></button>
                        </div>
                    </div>
                </header>
                <p id="directory-loading">Loading directory...</p>
                <zing-grid
                    id="directory-grid"
                    pager
                    page-size="25"
                    page-size-options="10,25,50,100"
                    search
                    sort
                    >
                </zing-grid>
            </article>
            <modal-component footer="none" id="add-user-modal">
                <h4 slot="header">Add User</h4>
                <add-user-form slot="content"></add-user-form>
            <modal-component>
        </main>
        <aside>
            <conductor-nav></conductor-nav>
        </aside>
        
        <script type="module">
            import { getCourseId, getUserRole } from '/src/js/utils/cache-utils.js';
            import { getAllUsersInCourse, getUserInCourse } from '/src/js/api/course.js';
            import { linkSearchToGrid } from '/src/js/utils/zinggrid.js';
            
            const directoryContent = document.getElementById('directory-content');
            const directoryLoading = document.getElementById('directory-loading');
            const directoryGrid = document.getElementById('directory-grid');
            const directoryError = document.getElementById('directory-error');
            const addUserButton = document.getElementById('add-user-button');
            const addUserModal = document.getElementById('add-user-modal');
            
            async function loadDirectory() {
                try {
                    // Get course ID from URL
                    const courseId = getCourseId();
                    if (!courseId) {
                        throw new Error('Course ID not found in URL');
                    }

                    // Fetch all enrollments to get list of user_ids
                    const enrollments = await getAllUsersInCourse(courseId);
                    
                    if (!enrollments || enrollments.length === 0) {
                        directoryLoading.textContent = 'No participants found in this course.';
                        return;
                    }

                    const gridData = enrollments.map(e => ({
                        first_name: e.user_first_name ?? 'N/A',
                        last_name: e.user_last_name ?? 'N/A',
                        email: e.user_email ?? 'N/A',
                        pronouns: e.pronouns ?? 'N/A',
                        role: e.role ?? 'N/A',
                        team_id: e.team_id ?? 'N/A',
                    }));

                    directoryGrid.data = gridData;
                    directoryLoading.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error loading directory:', error);
                    directoryLoading.style.display = 'none';
                    directoryError.textContent = `Error loading directory: ${error.message}`;
                    directoryError.style.display = 'block';
                }
            }

            if (addUserButton && getUserRole() !== 'professor') {
                addUserButton.style.display = 'none';
            } else if (addUserButton && addUserModal) {
                addUserButton.addEventListener('click', () => {
                    addUserModal.open();
                });
            }
            
            loadDirectory();

            window.addEventListener('load', () => {
                linkSearchToGrid('grid-search', 'directory-grid');
            });
        </script>
    </body>
</html>
