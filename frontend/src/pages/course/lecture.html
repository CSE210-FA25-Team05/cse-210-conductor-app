<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conductor - Lectures</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
    <script type="module" async src="/src/js/common.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="/src/js/charts/attendance-charts.js"></script>
  </head>

  <body>
    <main>
      <!-- Page Header -->
      <header>
        <h1>Course Lectures</h1>
      </header>

      <!-- Lecture Grid Section -->
      <article id="lecture-content">
        <header>
          <div class="grid-menu" role="menu">
            <input
              id="grid-search"
              type="search"
              placeholder="Search..."
              aria-label="Search your lectures"
            />
          </div>
        </header>

        <zing-grid
          id="lecture-grid"
          pager
          page-size="10"
          page-size-options="10,25,50,100"
          search
          sort
        ></zing-grid>

        <p id="lecture-error" style="display: none; color: var(--color-error);"></p>
      </article>

      <!-- Attendance Chart Section -->
      <article id="attendance-content">
        <header>
          <h2>Latest Lecture Attendance</h2>
        </header>

        <div class="chart-container" style="max-width: 500px; margin: 0 auto;">
          <div id="error-message" style="color: red;"></div>
          <canvas id="attendanceChart"></canvas>
        </div>
      </article>
    </main>

    <!-- Navigation Sidebar -->
    <aside>
      <conductor-nav></conductor-nav>
    </aside>

    <!-- Lecture Grid Script -->
    <script type="module">
      import { getCourseId, getUserRole } from "/src/js/utils/cache-utils.js";
      import { getLectures } from "/src/js/api/lecture.js";
      import { linkSearchToGrid } from '/src/js/utils/zinggrid.js';

      const lectureGrid = document.getElementById("lecture-grid");
      const lectureError = document.getElementById("lecture-error");

      function formatLectureDate(dateString) {
        const [year, month, day] = dateString.split("-");
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function determineLectureStatus(lectureDate) {
        const now = new Date();
        const [year, month, day] = lectureDate.split("-");
        const date = new Date(year, month - 1, day);

        const sameDay =
          date.getFullYear() === now.getFullYear() &&
          date.getMonth() === now.getMonth() &&
          date.getDate() === now.getDate();

        if (sameDay) return "today";
        if (now < date) return "upcoming";
        return "finished";
      }

      async function loadLectureData() {
        try {
          const courseId = getCourseId();
          if (!courseId) throw new Error("Course ID not found");

          const lectures = await getLectures(courseId);
          const role = getUserRole();

          if (!lectures || lectures.length === 0) {
            lectureError.textContent = "No lectures found for this course.";
            lectureError.style.display = "block";
            return;
          }

          let processedLectures;
          if (role === 'professor' || role === 'ta') {
            processedLectures = lectures.map((lec) => ({
              lecture_date: formatLectureDate(lec.lecture_date),
              status: determineLectureStatus(lec.lecture_date),
              attendance: `<prof-attendance lecture-id=${lec.id}></prof-attendance>`
            }));
          } else{
            processedLectures = lectures.map((lec) => ({
              lecture_date: formatLectureDate(lec.lecture_date),
              status: determineLectureStatus(lec.lecture_date),
              attendance: `<student-attendance lecture-id=${lec.id}></student-attendance>`
            }));
          }

          // Sort: today → upcoming → finished
          const order = { today: 1, upcoming: 2, finished: 3 };
          processedLectures.sort(
            (a, b) => order[a.status] - order[b.status]
          );

          lectureGrid.data = processedLectures;
        } catch (err) {
          lectureError.textContent = `Error loading lecture data: ${err.message}`;
          lectureError.style.display = "block";
        }
      }

      loadLectureData();

      window.addEventListener('load', () => {
        linkSearchToGrid('grid-search', 'lecture-grid');
      });
    </script>
  </body>
</html>
