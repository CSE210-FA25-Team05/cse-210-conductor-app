<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conductor - Lectures</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
    <script type="module" async src="/src/js/common.js"></script>
  </head>
  <body>
    <main>
      <header>
        <h1>Course Lectures</h1>
        <theme-toggle></theme-toggle>
      </header>
      <article id="lecture-content">
        <p id="lecture-loading">Loading lecture data...</p>
        <zing-grid
          id="lecture-grid"
          style="display: block;"
          caption="Course Lectures"
          theme="default"
          pager
          page-size="10"
          page-size-options="10,25,50,100"
          search
        >
        </zing-grid>
        <p
          id="lecture-error"
          style="display: none; color: var(--color-error);"
        ></p>
      </article>
    </main>
    <aside>
      <conductor-nav></conductor-nav>
    </aside>

    <script type="module">
      import { getCourseId } from "/src/js/utils/cache-utils.js";
      import { getLectures } from "/src/js/api/lecture.js";

      const lectureContent = document.getElementById("lecture-content");
      const lectureLoading = document.getElementById("lecture-loading");
      const lectureGrid = document.getElementById("lecture-grid");
      const lectureError = document.getElementById("lecture-error");

      async function loadLectureData() {
        try {
          const courseId = getCourseId();
          if (!courseId) throw new Error("Course ID not found in URL");

          const lectures = await getLectures(courseId);
          if (!lectures || lectures.length === 0) {
            lectureLoading.textContent =
              "No lectures found for this course.";
            return;
          }

          const now = new Date();

          // Determine lecture status
          const lecturesWithStatus = lectures.map((lec) => {
            const start = new Date(lec.lecture_date);

            // Normalize year, month, day to compare dates
            const sameDay =
              start.getFullYear() === now.getFullYear() &&
              start.getMonth() === now.getMonth() &&
              start.getDate() === now.getDate();

            let status;

            if (sameDay) {
              status = "today";
            } else if (now < start) {
              status = "upcoming";
            } else {
              status = "finished";
            }

            return {
              lecture_date: start.toLocaleString(),
              status,
            };
          });

          // Sort order: today → upcoming → finished
          const statusOrder = { today: 1, upcoming: 2, finished: 3 };
          const sortedLectures = lecturesWithStatus.sort(
            (a, b) => statusOrder[a.status] - statusOrder[b.status]
          );

          // Populate ZingGrid
          lectureGrid.data = sortedLectures;
          lectureLoading.style.display = "none";
        } catch (error) {
          console.error("Error loading lecture data:", error);
          lectureLoading.style.display = "none";
          lectureError.textContent = `Error loading lecture data: ${error.message}`;
          lectureError.style.display = "block";
        }
      }

      loadLectureData();
    </script>
  </body>
</html>
