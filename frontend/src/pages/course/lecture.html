<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Conductor - Lectures</title>
    <link rel="stylesheet" href="/src/styles/styles.css" />
    <script type="module" async src="/src/js/common.js"></script>
  </head>
  <body>
    <main>
      <header>
        <h1>Course Lectures</h1>
      </header>

      <article id="lecture-content">

        <header>
            <div class="grid-menu" role="menu">
                <input
                    id="grid-search"
                    type="search"
                    placeholder="Search..."
                    aria-label="Search your pulses"
                />
            </div>
        </header>

        <zing-grid
          id="lecture-grid"
          pager
          page-size="10"
          page-size-options="10,25,50,100"
          search
          sort
        ></zing-grid>

        <p
          id="lecture-error"
          style="display: none; color: var(--color-error);"
        ></p>
      </article>
      <student-attendance></student-attendance>
    </main>

    <aside>
      <conductor-nav></conductor-nav>
    </aside>

    <script type="module">
      import { getCourseId, getUserRole } from "/src/js/utils/cache-utils.js";
      import { getLectures } from "/src/js/api/lecture.js";
      import { linkSearchToGrid } from '/src/js/utils/zinggrid.js';

      const lectureLoading = document.getElementById("lecture-loading");
      const lectureGrid = document.getElementById("lecture-grid");
      const lectureError = document.getElementById("lecture-error");

      function formatLectureDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      }

      function determineLectureStatus(lectureDate) {
        const now = new Date();
        const date = new Date(lectureDate);

        const sameDay =
          date.getFullYear() === now.getFullYear() &&
          date.getMonth() === now.getMonth() &&
          date.getDate() === now.getDate();

        if (sameDay) return "today";
        if (now < date) return "upcoming";
        return "finished";
      }

      async function loadLectureData() {
        try {
          const courseId = getCourseId();
          if (!courseId) throw new Error("Course ID not found");

          const lectures = await getLectures(courseId);
          const role = getUserRole();

          if (!lectures || lectures.length === 0) {
            lectureLoading.textContent = "No lectures found for this course.";
            return;
          }

          let processedLectures;
          if (role === 'professor' || role === 'ta') {
            processedLectures = lectures.map((lec) => ({
              lecture_date: formatLectureDate(lec.lecture_date),
              status: determineLectureStatus(lec.lecture_date),
              attendance: `<prof-attendance lecture-id=${lec.id}></prof-attendance>`
            }));
          } else{
            processedLectures = lectures.map((lec) => ({
              lecture_date: formatLectureDate(lec.lecture_date),
              status: determineLectureStatus(lec.lecture_date),
            }));
          }

          // Sort: today → upcoming → finished
          const order = { today: 1, upcoming: 2, finished: 3 };
          processedLectures.sort(
            (a, b) => order[a.status] - order[b.status]
          );

          lectureGrid.data = processedLectures;
          lectureLoading.style.display = "none";
        } catch (err) {
          lectureLoading.style.display = "none";
          lectureError.textContent = `Error loading lecture data: ${err.message}`;
          lectureError.style.display = "block";
        }
      }

      loadLectureData();

      window.addEventListener('load', () => {
          linkSearchToGrid('grid-search', 'lecture-grid');
      });
    </script>
  </body>
</html>
