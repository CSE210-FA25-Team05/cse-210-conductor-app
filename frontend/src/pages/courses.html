<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Conductor</title>
        <link rel="stylesheet" href="/src/styles/styles.css">
        <script type="module" async src="/src/js/common.js"></script>
        <script type="module" async src="/src/components/forms/join-course.js"></script>
        <script type="module" async src="/src/components/forms/create-course.js"></script>
    </head>
    <body>
        <main>
            <header>
                <h1>Welcome to Conductor!</h1>
            </header>

            <section> 
                <article>
                    <header>
                        <h2>Join Course</h2>
                    </header>
                    <join-course-form></join-course-form>
                </article>

                <!-- Create Course Section - hidden by default -->
                <article id="create-course-section" style="display: none;">
                    <header>
                        <h2>Create Course</h2>
                    </header>
                    <create-course-form></create-course-form>
                </article>

                <article>
                    <header>
                        <h2>Your Courses</h2>
                    </header>
                    <ul id="courses-list"></ul>
                    <pre id="courses-response" style="color: red;"></pre>
                </article>
            </section> 

            <script type="module">
                import { getUserRole } from '/src/js/utils/cache-utils.js';

                document.addEventListener("DOMContentLoaded", async () => {
                    const listElement = document.getElementById("courses-list");
                    const responseElement = document.getElementById("courses-response");
                    const createCourseSection = document.getElementById("create-course-section");

                    // Show "Create Course" only if role is Professor
                    const role = await getUserRole();
                    if (role === "Professor") {
                        createCourseSection.style.display = "";
                    }

                    // Clear previous content
                    listElement.innerHTML = "";
                    responseElement.textContent = "";

                    try {
                        const response = await fetch("/api/courses", {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            credentials: "include",
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.message || "Failed to fetch courses");
                        }

                        if (!Array.isArray(result) || result.length === 0) {
                            listElement.innerHTML = "<li>No enrolled courses found.</li>";
                            return;
                        }

                        // Build the list dynamically
                        for (const course of result) {
                            const li = document.createElement("li");
                            const a = document.createElement("a");

                            // Show "course_code: course_name"
                            const code = course.course_code || "";
                            const name = course.course_name || "";
                            a.textContent = `${code}: ${name}`;

                            a.href = `/course/${course.id}/dashboard`;
                            li.appendChild(a);
                            listElement.appendChild(li);
                        }
                    } catch (error) {
                        responseElement.textContent = `Error: ${error.message}`;
                    }
                });
            </script>
        </main>
    </body>
</html>
