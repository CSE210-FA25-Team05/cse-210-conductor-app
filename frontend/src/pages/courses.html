<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Conductor</title>
        <link rel="stylesheet" href="/src/styles/styles.css">
        <script type="module" async src="/src/js/common.js"></script>
        <script type="module" async src="/src/components/forms/join-course.js"></script>
        <script type="module" async src="/src/components/forms/create-course.js"></script>
        <style>
            .courses-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: auto auto;
                gap: var(--spacing-large);
                max-width: 80dvw;
                margin: 0 auto;
            }
            .courses-container article {
                box-sizing: border-box;
                width: 100%;   /* ensures horizontal fill */
                height: 100%;
            }

            /* Make the third article span the full width */
            .courses-container article:nth-child(3) {
                grid-column: 1 / 3;
            }
            .welcome-header {
                text-align: center;
                margin-bottom: var(--spacing-large);
            }

            /* Course list styling */
            #courses-list {
                list-style: none;
                padding: 0;
                margin: 0;
                display: flex;
                flex-direction: column;
                gap: var(--spacing-small, 0.5rem);
            }

            #courses-list a {
                display: block;
                padding: var(--spacing-medium, 1rem);
                border: 1px solid var(--color-border, #ddd);
                border-radius: var(--radius-medium, 8px);
                text-decoration: none;
                color: inherit;
                background: var(--color-surface, #fff);
                transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            }

            #courses-list a:hover {
                background: var(--color-surface-hover, #f7f7f7);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                transform: translateY(-1px);
            }

            /* At 720px and below, switch to one-column layout */
            @media (max-width: 720px) {
                .courses-container {
                    grid-template-columns: 1fr;
                }

                .courses-container article:nth-child(3) {
                    grid-column: auto;
                }
            }

        </style>
    </head>
    <body>
        <main>
            <header class='welcome-header'>
                <h1>Welcome to Conductor!</h1>
            </header>

            <section class="courses-container"> 
                <article>
                    <header>
                        <h2>Join Course</h2>
                    </header>
                    <join-course-form></join-course-form>
                </article>

                <article>
                    <header>
                        <h2>Your Courses</h2>
                    </header>
                    <ul id="courses-list"></ul>
                    <pre id="courses-response" style="color: red;"></pre>
                </article>

                <!-- Create Course Section - hidden by default for non-professors -->
                <article id="create-course-section" style="display: none;">
                    <header>
                        <h2>Create Course</h2>
                    </header>
                    <create-course-form></create-course-form>
                </article>
            </section> 

            <script type="module">
                import { getUserRole } from '/src/js/utils/cache-utils.js';

                document.addEventListener("DOMContentLoaded", async () => {
                    const listElement = document.getElementById("courses-list");
                    const responseElement = document.getElementById("courses-response");
                    const createCourseSection = document.getElementById("create-course-section");

                    // Show "Create Course" only if role is Professor (case-insensitive)
                    const role = getUserRole();
                    if ((role || "").toLowerCase() === "professor") {
                        createCourseSection.style.display = "";
                    }

                    // Clear previous content
                    listElement.innerHTML = "";
                    responseElement.textContent = "";

                    try {
                        const response = await fetch("/api/courses", {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            credentials: "include",
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.message || "Failed to fetch courses");
                        }

                        if (!Array.isArray(result) || result.length === 0) {
                            listElement.innerHTML = "<li>No enrolled courses found.</li>";
                            return;
                        }

                        // Build the list dynamically
                        for (const course of result) {
                            const li = document.createElement("li");
                            const a = document.createElement("a");

                            // Show "course_code: course_name"
                            const code = course.course_code || "";
                            const name = course.course_name || "";
                            a.textContent = `${code}: ${name}`;

                            a.href = `/course/${course.id}/dashboard`;
                            li.appendChild(a);
                            listElement.appendChild(li);
                        }
                    } catch (error) {
                        responseElement.textContent = `Error: ${error.message}`;
                    }
                });
            </script>
        </main>
        <conductor-footer></conductor-footer>
    </body>
</html>
