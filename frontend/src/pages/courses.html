<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Conductor</title>
        <link rel="stylesheet" href="/src/styles/styles.css">
        <script type="module" async src="/src/js/common.js"></script>
        <script type="module" async src="/src/components/forms/join-course.js"></script>
        <script type="module" async src="/src/components/forms/create-course.js"></script>
    </head>
    <body>
        <main>
            <header>
                <h1>Welcome to Conductor!</h1>
            </header>
            <section> 
                <article>
                    <header>
                        <h2>Join Course</h2>
                    </header>
                    <join-course-form></join-course-form>
                </article>
                <article>
                    <header>
                        <h2>Create Course</h2>
                    </header>
                    <create-course-form></create-course-form>
                </article>
                <article>
                    <header>
                        <h2>Your Courses</h2>
                    </header>
                    <ul id="courses-list"></ul>
                    <pre id="courses-response" style="color: red;"></pre>
                </article>
            </section> 

            <h1>BELOW IS FOR CONVENIENCE</h1>
            <p>Note: We need to make this page look better</p>

            <h1>Me</h1>
            <div id="profile" class="profile">Loading...</div>
            <button id="complete-profile">Complete Profile</button>

            <h1>Courses</h1>


            <script>
            document
                .getElementById("complete-profile")
                .addEventListener('click', async () => {
                    const data = {
                        first_name: "string",
                        last_name: "string",
                        pronouns: "string",
                    }
                    const response = await fetch("/api/me/profile", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        credentials: 'include',
                        body: JSON.stringify(data),
                    });
                });


            async function loadProfile() {
                const container = document.getElementById("profile");

                try {
                    const response = await fetch("/api/me/profile");
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    container.innerHTML = `
                        <h2>${data.first_name} ${data.last_name}</h2>
                        <div class="profile-item"><strong>Email:</strong> ${data.email}</div>
                        <div class="profile-item"><strong>Pronouns:</strong> ${
                            data.pronouns || "N/A"
                            }</div>
                        <div class="profile-item"><strong>Role:</strong> ${
                            data.global_role
                            }</div>
                        <div class="profile-item"><strong>Profile Complete:</strong> ${
                            data.is_profile_complete ? "Yes" : "No"
                            }</div>
                        <div class="profile-item"><small>ID: ${data.id}</small></div>
                    `;
                } catch (error) {
                    console.error("Error fetching profile:", error);
                    container.innerHTML =
                        '<div class="error">Failed to load profile information.</div>';
                }
            }

            loadProfile();

            document
                .addEventListener("DOMContentLoaded", async () => {
                    const listElement = document.getElementById("courses-list");
                    const responseElement = document.getElementById("courses-response");

                    // Clear previous content
                    listElement.innerHTML = "";
                    responseElement.textContent = "";

                    try {
                        const response = await fetch("/api/courses", {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            credentials: "include",
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.message || "Failed to fetch courses");
                        }

                        if (!Array.isArray(result) || result.length === 0) {
                            listElement.innerHTML =
                                "<li>No enrolled courses found.</li>";
                            return;
                        }

                        // Build the list dynamically
                        for (const course of result) {
                            const li = document.createElement("li");
                            const a = document.createElement("a");

                            // If your API uses another identifier, adjust 'course.id' accordingly
                            a.href = `/course/${course.id}/dashboard`;
                            a.textContent = course.course_name || course.course_code || course.id;

                            li.appendChild(a);
                            listElement.appendChild(li);
                        }
                    } catch (error) {
                        responseElement.textContent = `Error: ${error.message}`;
                    }
                });


            </script>
    </body>

</html>
